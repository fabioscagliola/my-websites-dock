---

- name: Build the image
  hosts: localhost
  tags: build
  tasks:
    - name: Create a temporary folder
      ansible.builtin.file:
        path: /tmp/my-websites-dock
        state: directory

    - name: Build the image
      community.docker.docker_image:
        archive_path: /tmp/my-websites-dock/my-websites-dock.tar
        build:
          path: .
          platform: linux/amd64
          nocache: true
        force_source: true
        name: my-websites-dock
        source: build

    - name: Compress the image
      community.general.archive:
        path: /tmp/my-websites-dock/my-websites-dock.tar

- name: Deploy the container
  become: true
  hosts: my-websites-dock
  tags: deploy
  tasks:
    - name: Stop the container
      community.docker.docker_container:
        image: my-websites-dock
        name: my-websites-dock
        state: stopped

    - name: Prune the containers
      command: docker container prune -f

    - name: Prune the images
      command: docker image prune -a -f

    - name: Upload the image to the server
      ansible.builtin.copy:
        src: /tmp/my-websites-dock/my-websites-dock.tar.gz
        dest: /data/my-websites-dock.tar.gz

    - name: Extract the image
      ansible.builtin.command: gzip -d /data/my-websites-dock.tar.gz

    - name: Load the image
      community.docker.docker_image:
        load_path: /data/my-websites-dock.tar
        name: my-websites-dock
        source: load

    - name: Delete the image
      ansible.builtin.file:
        path: /data/my-websites-dock.tar
        state: absent

    - name: Start the container
      community.docker.docker_container:
        image: my-websites-dock
        name: my-websites-dock
        ports:
          - "80:80"
          - "443:443"
        restart_policy: unless-stopped
        state: started

- name: Cleanup the local environment
  hosts: localhost
  tags: cleanup
  tasks:
    - name: Delete the temporary folder
      ansible.builtin.file:
        path: /tmp/my-websites-dock
        state: absent

    - name: Delete the images
      community.docker.docker_image:
        name: my-websites-dock
        state: absent

