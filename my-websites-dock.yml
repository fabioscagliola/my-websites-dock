---

- name: Build the websites
  hosts: localhost
  tags: build-sites
  tasks:
    - name: Create the websites' folders
      ansible.builtin.file:
        path: './websites/{{ item }}/contents'
        state: directory
      loop:
        - assessyoursecurity.com
        - bloodbankhub.com
        - fabioscagliola.com
        - laurabernasconi.com
        - notforprof.it
        - nothence.com
        - pmmv.nothence.com
        - step.fabioscagliola.com
        - thesoftwaretailors.com

    - name: Create a temporary folder
      ansible.builtin.file:
        path: /tmp/my-websites-dock
        state: directory

    - name: Clone the repos
      ansible.builtin.git:
        repo: '{{ item.repo }}'
        dest: '/tmp/my-websites-dock/{{ item.dest }}'
      loop:
        - repo: git@github.com:fabioscagliola/my-site-and-blog.git
          dest: fabioscagliola.com
        - repo: git@github.com:fabioscagliola/bernie.git
          dest: laurabernasconi.com
        - repo: git@github.com:fabioscagliola/Nothence.git
          dest: nothence.com

    - name: Delete the public folders of the websites made with Hugo
      ansible.builtin.file:
        path: '{{ item }}/public'
        state: absent
      loop:
        - /tmp/my-websites-dock/fabioscagliola.com/fabioscagliola
        - /tmp/my-websites-dock/laurabernasconi.com/website
        - //tmp/my-websites-dock/nothence.com/nothence

    - name: Build the websites made with Hugo
      command: hugo
      args:
        chdir: '{{ item }}'
      loop:
        - /tmp/my-websites-dock/fabioscagliola.com/fabioscagliola
        - /tmp/my-websites-dock/laurabernasconi.com/website
        - //tmp/my-websites-dock/nothence.com/nothence

    - name: Copy the contents of the websites made with Hugo
      ansible.builtin.copy:
        src: '{{ item.source }}/public/'
        dest: './websites/{{ item.target }}/contents'
      loop:
        - source: /tmp/my-websites-dock/fabioscagliola.com/fabioscagliola
          target: fabioscagliola.com
        - source: /tmp/my-websites-dock/laurabernasconi.com/website
          target: laurabernasconi.com
        - source: //tmp/my-websites-dock/nothence.com/nothence
          target: nothence.com

#    - name: Copy the Assess Your Security website
#      ansible.builtin.copy:
#        src: /Users/fabioscagliola/Documents/Tailors/Assess Your Security/AssessYourSecuritySite/
#        dest: /tmp/my-websites-dock/websites/assessyoursecurity.com/contents
#
#    - name: Copy the Blood Bank Hub website
#      ansible.builtin.copy:
#        src: /Users/fabioscagliola/Documents/Tailors/Blood Bank Hub/BloodBankHubSite/
#        dest: /tmp/my-websites-dock/websites/bloodbankhub.com/contents
#
#    - name: Copy the Not For Prof.it website
#      ansible.builtin.copy:
#        src: /Users/fabioscagliola/Documents/Tailors/Not For Prof.it/NotForProfSite/
#        dest: /tmp/my-websites-dock/websites/notforprof.it/contents
#
#    - name: Copy the Post mortem memento vivere website
#      ansible.builtin.copy:
#        src: /Users/fabioscagliola/Documents/GitHub/fabioscagliola/pmmv/contents/
#        dest: /tmp/my-websites-dock/websites/pmmv.nothence.com/contents
#
#    - name: Copy the Step website
#      ansible.builtin.copy:
#        src: /Users/fabioscagliola/Documents/GitHub/fabioscagliola/Step/src/
#        dest: /tmp/my-websites-dock/websites/step.fabioscagliola.com/contents
#
#    - name: Copy The Software Tailors' website
#      ansible.builtin.copy:
#        src: /Users/fabioscagliola/Documents/Tailors/Website/TheSoftwareTailorsSite/
#        dest: /tmp/my-websites-dock/websites/thesoftwaretailors.com/contents

- name: Build the image
  hosts: localhost
  tags: build-image
  tasks:
    - name: Build the image
      community.docker.docker_image:
        archive_path: /tmp/my-websites-dock/my-websites-dock.tar
        build:
          path: .
          platform: linux/amd64
          nocache: true
        force_source: true
        name: my-websites-dock
        source: build

    - name: Compress the image
      community.general.archive:
        path: /tmp/my-websites-dock/my-websites-dock.tar

- name: Deploy the container
  become: true
  hosts: my_websites_dock
  tags: deploy
  tasks:
    - name: Stop the container
      community.docker.docker_container:
        image: my-websites-dock
        name: my-websites-dock
        state: stopped

    - name: Prune the containers
      command: docker container prune -f

    - name: Prune the images
      command: docker image prune -a -f

    - name: Upload the image to the server
      ansible.builtin.copy:
        src: /tmp/my-websites-dock/my-websites-dock.tar.gz
        dest: /data/my-websites-dock.tar.gz

    - name: Extract the image
      ansible.builtin.command: gzip -d /data/my-websites-dock.tar.gz

    - name: Load the image
      community.docker.docker_image:
        load_path: /data/my-websites-dock.tar
        name: my-websites-dock
        source: load

    - name: Delete the image
      ansible.builtin.file:
        path: /data/my-websites-dock.tar
        state: absent

    - name: Start the container
      community.docker.docker_container:
        image: my-websites-dock
        name: my-websites-dock
        ports:
          - "80:80"
          - "443:443"
        restart_policy: unless-stopped
        state: started

- name: Cleanup the local environment
  hosts: localhost
  tags: cleanup
  tasks:
    - name: Delete the contents folders
      ansible.builtin.file:
        path: ./websites
        state: absent

    - name: Delete the temporary folder
      ansible.builtin.file:
        path: /tmp/my-websites-dock
        state: absent

    - name: Delete the images
      community.docker.docker_image:
        name: '{{ item }}'
        state: absent
      loop:
        - my-websites-dock
        - nginx

